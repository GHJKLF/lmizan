CREATE OR REPLACE FUNCTION public.get_balance_reconciliation() RETURNS TABLE (account text, currency text, provider text, computed_balance numeric, api_balance numeric, difference numeric, difference_pct numeric, api_fetched_at timestamptz, status text) LANGUAGE sql STABLE SECURITY DEFINER SET search_path TO 'public' AS $$ WITH computed AS (SELECT t.account, UPPER(COALESCE(t.currency, 'EUR')) AS currency, SUM(CASE WHEN t.type = 'Inflow' THEN t.amount WHEN t.type = 'Outflow' THEN -t.amount ELSE 0 END) AS balance FROM transactions t WHERE t.user_id = auth.uid() AND t.account IS NOT NULL AND t.currency IS NOT NULL GROUP BY t.account, UPPER(COALESCE(t.currency, 'EUR'))), api AS (SELECT ab.account, ab.currency, ab.api_balance, ab.fetched_at, ab.provider FROM api_balances ab WHERE ab.user_id = auth.uid()) SELECT COALESCE(c.account, a.account) AS account, COALESCE(c.currency, a.currency) AS currency, COALESCE(a.provider, 'unknown') AS provider, COALESCE(c.balance, 0) AS computed_balance, COALESCE(a.api_balance, 0) AS api_balance, COALESCE(a.api_balance, 0) - COALESCE(c.balance, 0) AS difference, CASE WHEN ABS(COALESCE(c.balance, 0)) > 0 THEN ROUND(((COALESCE(a.api_balance, 0) - COALESCE(c.balance, 0)) / ABS(c.balance)) * 100, 2) ELSE NULL END AS difference_pct, a.fetched_at AS api_fetched_at, CASE WHEN a.api_balance IS NULL THEN 'no_api_data' WHEN ABS(COALESCE(a.api_balance, 0) - COALESCE(c.balance, 0)) < 1 THEN 'matched' WHEN ABS(COALESCE(a.api_balance, 0) - COALESCE(c.balance, 0)) < 100 THEN 'minor_diff' ELSE 'major_diff' END AS status FROM computed c FULL OUTER JOIN api a ON c.account = a.account AND c.currency = a.currency; $$;